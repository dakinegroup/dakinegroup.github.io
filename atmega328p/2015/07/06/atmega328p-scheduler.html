<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="dakinegroup.com" name="application-name">
<meta content="Vineet Maheshwari" name="author">
<meta content="A Website of da Kine Technologies Pvt. Ltd. (Gurgaon, India)" name="description">
<meta content="tech,configuration,angular,php,codeigniter,android,jekyll,nodejs,javascript,html5,excel vba" name="keywords">
<meta content="Jekyll 2.0.0" name="generator">
  <title>Scheduler for ATMega328p</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="/bootstrap-glyphicons/css/bootstrap.icon-large.min.css">
  <link rel="stylesheet" href="/Font-Awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css" />
  <link href='http://fonts.googleapis.com/css?family=Lato:400,100,700,300italic,100italic,900italic' rel='stylesheet' type='text/css'>

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

</head>



<body class="wrap">
  <nav class="navbar navbar-fixed-top navbar-default">
<div class="container">
<div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="i  con-bar"></span>
</button>
 
<a class="navbar-brand" href="/index.html">da Kine Technologies Pvt. Ltd.</a>
<div style=" display: inline-block;
    font-style: italic;
    margin-left: -79px;
    margin-top: 39px;">Simplify.Value.Reuse</div>
</div>
 
<!-- Collect the nav links, forms, and other content for toggling -->
<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav navbar-right">
 

 
<!-- check to see if the data file has a submenu, and if so display it -->

 
<!-- display the top level navigation for items that don’t have a submenu -->
<li>
<a href="/">Home</a>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

<li class="dropdown">
<a href="" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">Who are we?<i class="fa fa-angle-down"></i></a>
<ul class="dropdown-menu">

<li><a href="/company/team/index.html">Introduction</a></li>

<li><a href="/company/team/founder.html">Founder</a></li>

<li><a href="/company/skills/index.html">Skills</a></li>

</ul>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

<li class="dropdown">
<a href="" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">What We do..<i class="fa fa-angle-down"></i></a>
<ul class="dropdown-menu">

<li><a href="/company/services/index.html">Services</a></li>

<li><a href="/company/skills/index.html">Skills</a></li>

<li><a href="/company/reusables/index.html">Resuse</a></li>

<li><a href="/company/opensource/index.html">Open Source</a></li>

</ul>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

<li class="dropdown">
<a href="" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">Way we do<i class="fa fa-angle-down"></i></a>
<ul class="dropdown-menu">

<li><a href="/company/process/index.html">Processes</a></li>

<li><a href="/company/process/proposal.html">Proposal</a></li>

<li><a href="/company/process/requirements.html">Requirements</a></li>

<li><a href="/company/process/implementation.html">Implementation</a></li>

<li><a href="/company/process/configmanagement.html">Configuration Management</a></li>

<li><a href="/company/process/support.html">Support</a></li>

</ul>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

<li class="dropdown">
<a href="" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">Why Us<i class="fa fa-angle-down"></i></a>
<ul class="dropdown-menu">

<li><a href="/company/whyus/index.html">Why Us</a></li>

<li><a href="/company/whyus/mission.html">Mission</a></li>

<li><a href="/company/whyus/values.html">Values</a></li>

</ul>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

<li class="dropdown">
<a href="" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown">Articles<i class="fa fa-angle-down"></i></a>
<ul class="dropdown-menu">

<li><a href="/categories/excelmacros">Excel Macros</a></li>

<li><a href="/categories/mobileappsjs">Mobile Apps - JS</a></li>

<li><a href="/categories/mobileappsjavac">Mobile Apps - Java/Objective-C</a></li>

<li><a href="/categories/portalcomponents">Portal Components</a></li>

<li><a href="/categories/atmega328p">ATmega328p</a></li>

<li><a href="/categories/embeddedandroid">Embedded Android</a></li>

<li><a href="/categories/bigdata">Big Data</a></li>

</ul>

</li>

 
<!-- check to see if the data file has a submenu, and if so display it -->

 
<!-- display the top level navigation for items that don’t have a submenu -->
<li>
<a href="/company/contactus/index.html">Contact Us</a>

</li>

</ul>
</div><!-- /.navbar-collapse -->
</div><!-- /.container -->
</nav> 
<div class='container' style="padding-bottom: 20px;">


  <section class="post">
<article>
<h1>Scheduler for ATMega328p</h1>
<div style="margin-bottom: 10px;">
<div>Vineet Maheshwari, 6 July 2015, Gurgaon</div>
<div><b>Categories:</b> atmega328p</div><div>

<b>Tags:</b> 

<a href="/tag/microcontrollers">microcontrollers</a> 
<a href="/tag/embedded">embedded</a> 
<a href="/tag/programming">programming</a> 
<a href="/tag/scheduler">scheduler</a> </div>
</div>
<h1 id="dealing-with-complex-situations-with-timing-constraints">Dealing with complex situations with timing constraints</h1>
<p>Lot of time goes into making things work at hardware level and the enthusiam is also limited to see basic peripherals are working as per expectations. But when it comes to delivering value for end customer, a complex solution would need to be worked out matching to the complex (which may appear simple) requirement of customers.</p>

<h1 id="when-is-it-required">When is it required?</h1>
<p>In many situations, there would be more than one task which needs to be carried out by mini-controller and most of them are constrained by timing requirements. Peripherals are an interface to external world and by nature they are slower and unpredictable. If processor works in turn with each of them, it may miss out on timing as well as some inputs could be over-written.</p>

<p>It is at this time, interrupts help to capture everything that comes in, a design to breakup huge time-consuming tasks and than scheduler to carry out these pieces in quick succession.</p>

<h1 id="understanding-the-interrupts">Understanding the Interrupts</h1>
<p>Interrupt by it’s definition means, a regular work whatever it may be is interrupted to carry out a higher priority task. At Hardware, this enables to catch events in real-time and store them for later processing. It even can be processed, if it does not take too much time. Program blocks that service these interrupts (ISRs) should take as little clock cycles as possible. Therefore it is always preferred to write them in assembly language.</p>

<p>Interrupt must start by disabling global interrupt flag and end by enabling. Compiler takes care of saving the last instruction address, register values and retrieving them upon return.</p>

<p>All variables that ISR use need to be protected using cli() and sei() commands, to avoid conflicts in reading / writing. These variables are the way of sharing information between ISR and regular program flow.</p>

<p>An extract from the code for 16-bit timer interrupt:</p>

<pre>
ISR(TIMER1_OVF_vect)
{
  cli();
  // 4 byte timestamp, that is updated with every expiry of
  //  65535 clock cycles without prescaler
  // at a clock frequency of 12MHz it would be 1/12 usec x 65535 = 4ms
  // change timer control registers to change 4ms to other value
  timestamp[0] ++;
  if(timestamp[0] == 0) {
    timestamp[1] ++;
  }
  // keep this compiler conditional
  #if USE_DEBUG_LED
  if((timestamp[0] &amp; 0x003F) == 0) { 
    // check for lower 6 bits to become zero to
    //  switch on/off debugging LED which gives a time indication
    if(debug_led == 0) {
      debug_led = 0x01;
      PORTB = PORTB | _BV(1);
    } else {
      debug_led = 0;
      PORTB = PORTB &amp; ~(_BV(1));
    }
  }
  #endif
  sei();
}
</pre>

<h1 id="analysing-and-breaking-up-tasks">Analysing and Breaking up tasks</h1>
<p>Now using interrupts, it is possible to manage external world without wasting time in waiting for them to get ready. This is primarily needed for inputs Or to trigger events, where controller can be commanded to send an output. Our main loop should be such that it goes around different functions or we may call it as state machines. In these state machines, saved input data (coming from interrupts) is looked at and next action is either taken or scheduled. Actions may involve moving to next state, trigger some output or just ignore.</p>

<p>A framework can be designed with following components:</p>

<ul>
  <li>Regisration: An object that maintains functions list alongwith the timestamp, when they would be taken up next. These functions are the entry to state machine</li>
  <li>Invocation: In loop it goes through this object to find and execute if any of the statemachines is due for execution</li>
</ul>

<p>Programmer need to take care of not allowing time consuming actions to hold the controller, thereby causing others to fail to respond.</p>

<p>Registration code for example:</p>

<pre>
void repeat(int ms, tTimedCallBack cb) {
int i = 0;

    //add scheduled item to the queue
    for (i = 0; i &lt; MAX_TASKS; i++) {
        if(scheduledItems[i].empty) {
            cli(); //protected block
            scheduledItems[i].timestamp[0] = timestamp[0];
            scheduledItems[i].timestamp[1] = timestamp[1];
            sei();
            scheduledItems[i].timestamp[0] += ms;
            scheduledItems[i].recurrence = ms;
            scheduledItems[i].cb = cb;
            
            scheduledItems[i].empty = 0;
            break;
        }
    }
}

</pre>

<p>Lets say one has to write to a LCD display. Steps to write a string here would be</p>

<ul>
  <li>goto the location</li>
  <li>read next character</li>
  <li>write a character first nibble</li>
  <li>write a character second nibble</li>
  <li>read again</li>
</ul>

<p>one can schedule writing 4 characters at a time, with a interval of 100ms inside state machine, a cycle does not complete till all are written out, therefore as soon as it starts, it saves all the global/interrupt owned registers/values for use across state machine cycle. This is the simplest break up. It needs to be abstrated with a function that further drives a state machine. This state machine is repeated invoked in loop, for finishing of scheduled tasks. These state machines are like server performing tasks in background.</p>

<p>Maintain functions as function pointers in an array with mapping to events. This can be further extended to capture variables values and associated next state. A typical function pointer which takes integer as an argument and returns integer would be:</p>

<pre>
typedef int (* tTimedCallBack)(int);
</pre>

<h1 id="approach-to-building-final-code">Approach to building final code</h1>

<p>Breaking up things into smaller modules and components is the way to go. A big code being dealt at a time is a time waster and frustrating. So, one should breakup the embedded project into smaller peripheral driven projects / tasks. One should evolve their source / library around that peripheral with following two objectives in mind:</p>

<ul>
  <li>Develop ISR in C or assembly language, write initialization routine to drive this ISR</li>
  <li>Develop driver that acts as interface to user program logic for reading / writing to peripherals.</li>
  <li>Developer test user program to test above two things.</li>
</ul>

<p>Such code shall be easy to debug, take lesser time to be flashed on controller.</p>

<p>This phase of development may be called - peripheral component development.</p>

<p>Next comes evolve frameworks like scheduler, state machine, memory allocation, log handling - which basically form the fabric of application software. This may be done on machine to test the flow, logic and later ported to target platform. In this case, one need to protect code that is incompatible using #ifdef</p>

<p>Last in the process is integration of required components and fixing integration issues. This will be toughest of all and is highly inefficient because of getting involved with slower target platform and difficult to debug faults. Here the best way to troubleshoot is to do code-reviews.</p>

<h1 id="other-useful-articles">Other useful articles</h1>

<ul>
  <li><a href="">Tool Chain for ATmega328p</a></li>
  <li>Using GIT to manage source</li>
  <li>Tools for PCB Designing</li>
</ul>


<div style="width:100%; height: 40px; background-color: lightgrey;"></div>
</article>
</section>

  </div> <!-- for conatiner started in the top-->
<footer class="footer">
<div id='sitemap' class='row'>
    <div class='column col-md-4'>
         <h4>Recent Blogs</h4>
         <ul>
           <li> <a href="http://dakinegroup.github.io/atmega328p/2015/07/06/atmega328p-scheduler.html">Scheduler for ATMega328p</a></li>
           <li> <a href="http://dakinegroup.github.io/atmega328p/2015/07/01/atmega328p-freshers-look.html">ATMega328p - Freshers look</a></li>
           <li><a href="http://dakinegroup.github.io/excelmacros/2015/07/01/create-inexpensive-timesheets-solution.html">Creating inexpensive timesheet solution</a></li>
         </ul>
    </div>
    <div class=' column col-md-4'>
      <h4>Most Visited Pages</h4>
      <ul>
        <li> <a href="/company/services/index.html">Services</a></li>
        <li> <a href="/company/team/index.html">About Us</a></li>
      </ul>
    </div>
    <div class='column col-md-4'>
      <h4>Contat Us</h4>
      <div class="row">
        <div class="col col-md-4">email:</div>
        <div class="col col-md-8">info@dakinegroup.com</div>
        <div class="col col-md-4">phone:</div>
        <div class="col col-md-8">+91 9899799105</div>
      </div>
    </div>
</div>
  <div id='footer-disclaimer' class='row'>
    <center>This site is currently under development</center>
    <center>&copy; 2015. All rights reserved. &nbsp; | &nbsp; 
    <a href="/company/terms_and_conditions.html">Terms &amp; Conditions</a> &nbsp; | &nbsp;
    <a href="/company/disclaimer.html">Disclaimer</a>  &nbsp; | &nbsp;
    site: <a href='www.dakinegroup.com'> www.dakinegroup.com</a>
    </center>
  </div>
</footer>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>


</body>
</html>

